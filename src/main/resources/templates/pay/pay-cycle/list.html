<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>지급 주기 관리</title>

	<link rel="shortcut icon" href="/assets/img/favicon.png" type="image/x-icon">
	<link rel="stylesheet" href="/assets/css/bootstrap.min.css">
	<link rel="stylesheet" href="/assets/plugins/tabler-icons/tabler-icons.min.css">
	<link rel="stylesheet" href="/assets/plugins/fontawesome/css/fontawesome.min.css">
	<link rel="stylesheet" href="/assets/plugins/fontawesome/css/all.min.css">
	<link rel="stylesheet" href="/assets/css/dataTables.bootstrap5.min.css">
	<link rel="stylesheet" href="/assets/css/style.css">
</head>

<body>
	<div id="global-loader"><div class="page-loader"></div></div>

	<div class="main-wrapper">

		<div class="header">
			<div class="main-header">
				<div class="header-left"><a href="/" class="logo"><img src="/assets/img/logo.svg" alt="Logo"></a></div>
				<a id="toggle_btn" href="javascript:void(0);" class="btn btn-menubar me-1"><i class="ti ti-arrow-bar-to-left"></i></a>
				<a id="mobile_btn" class="mobile_btn" href="#sidebar"><span class="bar-icon"><span></span><span></span><span></span></span></a>
			</div>
		</div>
		
		<div th:replace="~{common/sidebar :: sidebar}"></div>

		<div class="page-wrapper">
			<div class="content">

				<div class="card">
					<div class="card-header">
						<h5 class="card-title">검색 조건</h5>
					</div>
					<div class="card-body">
						<form action="/pay/pay-cycle" method="get" id="searchForm">
							<div class="row">
								<div class="col-md-4">
									<div class="form-group">
										<label>직군 코드</label>
										<input class="form-control" name="jobGroup" placeholder="직군 코드로 검색" th:value="${jobGroup}">
									</div>
								</div>
								<div class="col-md-4">
									<div class="form-group">
										<label>사용 여부</label>
										<select class="form-select" name="useYn">
											<option value="">전체</option>
											<option value="Y" th:selected="${useYn == 'Y'}">Y (사용)</option>
											<option value="N" th:selected="${useYn == 'N'}">N (미사용)</option>
										</select>
									</div>
								</div>
								<div class="col-md-4 d-flex align-items-end">
									<div class="form-group w-100 position-relative">
										<button type="submit" class="btn btn-primary w-100">조회</button>
									</div>
								</div>
							</div>
						</form>
					</div>
				</div>

				<div class="card">
					<div class="card-header">
						<h5 class="card-title">지급 주기 목록</h5>
					</div>
					<div class="card-body">
						<div class="table-responsive">
							<table class="table table-striped table-hover datatable">
								<thead class="table-light">
									<tr>
										<th>직군코드</th>
										<th>기준시작일</th>
										<th>기준종료일</th>
										<th>실지급일</th>
										<th>사용여부</th>
										<th>비고</th>
										<th>수정</th>
									</tr>
								</thead>
								<tbody>
									<tr th:each="p : ${payCycle}">
										<td th:text="${p.jobGroup}"></td>
										<td th:text="${p.startDay}"></td>
										<td th:text="${p.endDay}"></td>
										<td th:text="${p.payDay}"></td>
										<td th:text="${p.useYn}"></td>
										<td th:text="${#strings.abbreviate(p.note, 50)}"></td>
										<td>
											<button class="btn btn-primary btn-sm edit-btn" data-bs-toggle="modal" data-bs-target="#editModal" 
												th:data-job-group="${p.jobGroup}">수정</button>
										</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>

				<div class="my-3 text-end">
					<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addModal">신규 등록</button>
				</div>

				<div class="modal fade" id="addModal" tabindex="-1">
				    <div class="modal-dialog modal-lg modal-dialog-centered">
				        <div class="modal-content">
				            <div class="modal-header">
				                <h5 class="modal-title">신규 지급 주기 등록</h5>
				                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				            </div>
				            <div class="modal-body">
				                <form id="addPayCycleForm">
				                    <div class="row">
				                        <div class="col-md-6 mb-3">
				                            <label class="form-label">직군 코드</label>
				                            <input type="text" class="form-control" name="jobGroup" required>
				                        </div>
				                        <div class="col-md-6 mb-3">
				                            <label class="form-label">기준 시작일</label>
				                            <input type="number" class="form-control" name="startDay" min="1" max="31" required>
				                        </div>
				                        <div class="col-md-6 mb-3">
				                            <label class="form-label">기준 종료일</label>
											<input type="number" class="form-control" name="endDay" min="1" max="31" required>
				                        </div>
				                        <div class="col-md-6 mb-3">
				                            <label class="form-label">실지급일</label>
				                            <input type="number" class="form-control" name="payDay" min="1" max="31" required>
				                        </div>
				                        <div class="col-md-6 mb-3">
				                            <label class="form-label">사용 여부</label>
				                            <div>
				                                <div class="form-check form-check-inline">
				                                    <input class="form-check-input" type="radio" value="Y" checked name="useYn">
				                                    <label class="form-check-label">Y (사용)</label>
				                                </div>
				                                <div class="form-check form-check-inline">
				                                    <input class="form-check-input" type="radio" value="N" name="useYn">
				                                    <label class="form-check-label">N (미사용)</label>
				                                </div>
				                            </div>
				                        </div>
				                        <div class="col-md-12 mb-3">
				                            <label class="form-label">설명 (비고)</label>
				                            <textarea class="form-control" rows="2" maxlength="500" name="note" placeholder="예: 사무직: 당월 1일~말일 기준, 당월 25일 지급"></textarea>
				                        </div>
				                    </div>
				                </form>
				            </div>
				            <div class="modal-footer gap-2">
				                <button type="reset" form="addPayCycleForm" class="btn btn-outline-secondary">초기화</button>
				                <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">취소</button>
				                <button type="button" onclick="addNewPayCycle()" class="btn btn-primary">저장</button>
				            </div>
				        </div>
				    </div>
				</div>

				<div class="modal fade" id="editModal" tabindex="-1">
				    <div class="modal-dialog modal-lg modal-dialog-centered">
				        <div class="modal-content">
				            <div class="modal-header">
				                <h5 class="modal-title">지급 주기 수정</h5>
				                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				            </div>
				            <div class="modal-body">
				                <form id="editPayCycleForm">
									<div class="row">
				                        <div class="col-md-6 mb-3">
				                            <label class="form-label">직군 코드</label>
				                            <input type="text" class="form-control" name="jobGroup" readonly>
				                        </div>
				                        <div class="col-md-6 mb-3">
				                            <label class="form-label">기준 시작일</label>
				                            <input type="number" class="form-control" name="startDay" min="1" max="31" required>
				                        </div>
				                        <div class="col-md-6 mb-3">
				                            <label class="form-label">기준 종료일</label>
											<input type="number" class="form-control" name="endDay" min="1" max="31" required>
				                        </div>
				                        <div class="col-md-6 mb-3">
				                            <label class="form-label">실지급일</label>
				                            <input type="number" class="form-control" name="payDay" min="1" max="31" required>
				                        </div>
				                        <div class="col-md-6 mb-3">
				                            <label class="form-label">사용 여부</label>
				                            <div>
				                                <div class="form-check form-check-inline">
				                                    <input class="form-check-input" type="radio" value="Y" name="useYn">
				                                    <label class="form-check-label">Y (사용)</label>
				                                </div>
				                                <div class="form-check form-check-inline">
				                                    <input class="form-check-input" type="radio" value="N" name="useYn">
				                                    <label class="form-check-label">N (미사용)</label>
				                                </div>
				                            </div>
				                        </div>
				                        <div class="col-md-12 mb-3">
				                            <label class="form-label">설명 (비고)</label>
				                            <textarea class="form-control" maxlength="500" rows="2" name="note"></textarea>
				                        </div>
				                    </div>
								</form>
				            </div>
				            <div class="modal-footer gap-2">
				                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
				                <button type="button" onclick="updatePayCycle()" class="btn btn-primary">변경사항 저장</button>
				            </div>
				        </div>
				    </div>
				</div>
				
			</div>

			<div th:replace="~{common/footer :: footer}"></div>
		</div>
	</div>

	<script src="/assets/js/jquery-3.7.1.min.js"></script>
	<script src="/assets/js/bootstrap.bundle.min.js"></script>
	<script src="/assets/js/jquery.slimscroll.min.js"></script>
	<script src="https://unpkg.com/feather-icons"></script>
	<script src="/assets/js/jquery.dataTables.min.js"></script>
	<script src="/assets/js/dataTables.bootstrap5.min.js"></script>
	<script src="/assets/js/script.js"></script>
	
	<script type="text/javascript">
	
	document.addEventListener('DOMContentLoaded', function () {
    	 
     		// 수정 모달창을 열 때, 불러오기.
	        const tableBody = document.querySelector('.datatable tbody');
		    if (tableBody) {
		        tableBody.addEventListener('click', function(event) {
		        	
		            const editButton = event.target.closest('.edit-btn');
		
		            
		            if (editButton) {
		                const jobGroup = editButton.dataset.jobGroup; 
		                findPayCycleDetail(jobGroup);
		            }
		        });
		    }
		});
	
	// 새 지급 주기 등록
    async function addNewPayCycle() {
		const addPayCycleForm = document.getElementById('addPayCycleForm');
	    const formData = new FormData(addPayCycleForm);
	    const data = Object.fromEntries(formData.entries());

	    // 항목코드 공백 검사
	    if (!data.jobGroup || !data.jobGroup.trim()) {
	        alert('직군 코드를 입력해주세요.');
	        return;
	    }
	    
	    // 날짜 공백 검사
	    if (!data.startDay || !data.endDay || !data.payDay) {
	    	alert('기준 시작일, 기준 종료일, 실지급일을 모두 입력해주세요.');
	    	return;
	    }
	    
	    // --- 서버 작업 시작 ---
	    try {
	        const response = await fetch(`/pay/pay-cycle/checkOverlap/${data.jobGroup}`);
	        
	        const checkResult = Number(await response.text());
	        
	        if (checkResult > 0) { 
	            alert('입력하신 직군 코드는 이미 존재합니다. 다른 코드를 사용해주세요.'); 
	            return;
	        }

	        // --- 중복 검사를 통과하면 최종 저장 (POST) ---
	        const saveResponse = await fetch('/pay/pay-cycle', {
	            method: 'POST',
	            headers: {
	                'Content-Type': 'application/json',
	            },
	            body: JSON.stringify(data),
	        });

	        if (saveResponse.ok) {
	            alert('성공적으로 등록되었습니다.');
	            location.reload();
	        } else {
	            const errorText = await saveResponse.text();
	            alert(`등록에 실패했습니다: ${errorText}`);
	        }

	    } catch (error) {
	        console.error('Error:', error);
	        alert('등록 중 오류가 발생했습니다.');
	    }
	};
	
	// 수정 모달창 데이터 불러오기.
	async function findPayCycleDetail(jobGroup) {
	    try {
	        const response = await fetch(`/pay/pay-cycle/detail/${jobGroup}`);
	        if (!response.ok) {
	            throw new Error('데이터를 불러오는 데 실패했습니다.');
	        }
	        const data = await response.json();
	        const editForm = document.getElementById('editPayCycleForm')


	        for (const key in data) {
	            const field = editForm.querySelector(`[name="${key}"]`);
	            
	            if(field) {
	            	
	            	if (field.type === 'radio') {
	            		
	            		editForm.querySelector(`[name="${key}"][value="${data[key]}"]`).checked = true;
	            	} else {
			            field.value = data[key];
	            	}
	            }
	        }

	    } catch (error) {
	        console.error('Error:', error);
	        alert(error.message);
	    }
	}
	
	//지급 주기 수정
	async function updatePayCycle() {
	    const editForm = document.getElementById('editPayCycleForm');
	    const formData = new FormData(editForm);
	    const data = Object.fromEntries(formData.entries());


	 	// 날짜 공백 검사
	    if (!data.startDay || !data.endDay || !data.payDay) {
	    	alert('기준 시작일, 기준 종료일, 실지급일을 모두 입력해주세요.');
	    	return;
	    }
	    
	    try {
	        const url = `/pay/pay-cycle/${data.jobGroup}`;
	        const response = await fetch(url, {
	            method: 'PUT', 
	            headers: {
	                'Content-Type': 'application/json',
	            },
	            body: JSON.stringify(data),
	        });

	        if (response.ok) {
	            alert('성공적으로 수정되었습니다.');
	            location.reload(); // 성공 시 페이지 새로고침
	        } else {
	            const errorText = await response.text();
	            alert(`수정에 실패했습니다: ${errorText}`);
	        }
	    } catch (error) {
	        console.error('Error:', error);
	        alert('수정 중 오류가 발생했습니다.');
	    }
	}
	</script>
</body>
</html>