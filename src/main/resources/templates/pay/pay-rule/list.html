<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{common/base}">
<head>
	<title>계산 규칙 관리</title>
</head>

<body>
	<div layout:fragment="content">


				<div class="card">
					<div class="card-header">
						<h5 class="card-title">검색 조건</h5>
					</div>
					<div class="card-body">
						<form action="/pay/pay-rule" method="get">
							<div class="row">
								<div class="col-md-3">
									<div class="form-group">
										<label>항목코드</label>
										<select  name="itemCode" multiple="multiple" class="form-control" id="searchPayItemSelect">
											<option th:each = "i : ${payItemList}" th:value="${i.itemCode}" th:text=|${i.itemName}(${i.itemCode})| th:selected="${itemCode != null && #lists.contains(itemCode, i.itemCode)}">
										</select>
									</div>
								</div>
								<div class="col-md-3">
									<div class="form-group">
										<label>계산 방식</label>
										<select class="form-select" name="ruleType" multiple="multiple" id="searchPayRuleSelect">
											<option value="FORMULA" th:selected="${ruleType != null && #lists.contains(ruleType, 'FORMULA')}">FORMULA</option>
											<option value="FIXED" th:selected="${ruleType != null && #lists.contains(ruleType, 'FIXED')}">FIXED</option>
											<option value="TABLE" th:selected="${ruleType != null && #lists.contains(ruleType, 'TABLE')}">TABLE</option>
											<option value="SQL" th:selected="${ruleType != null && #lists.contains(ruleType, 'SQL')}">SQL</option>
										</select>
									</div>
								</div>
								<div class="col-md-3">
									<div class="form-group">
										<label>사용 여부</label>
										<select class="form-select" name="useYn">
											<option value="">전체</option>
											<option value="Y" th:selected="${useYn == 'Y'}">Y</option>
											<option value="N" th:selected="${useYn == 'N'}">N</option>
										</select>
									</div>
								</div>
								<div class="col-md-3 d-flex align-items-end">
									<div class="form-group w-100">
										<button type="submit" class="btn btn-primary w-100">조회</button>
									</div>
								</div>
							</div>
						</form>
					</div>
				</div>

				<div class="card">
					<div class="card-header">
						<h5 class="card-title">계산 규칙 목록</h5>
					</div>
					<div class="card-body">
						<div class="table-responsive">
							<table class="table table-striped table-hover datatable-resizable" id="dataTable">
								<thead class="table-light">
									<tr>
										<th>항목코드</th>
										<th>계산방식</th>
										<th>수식/쿼리</th>
										<th>시작일</th>
										<th>종료일</th>
										<th>사용여부</th>
										<th>수정</th>
									</tr>
								</thead>
								<tbody>
									<tr th:each="r : ${payRule}">
										<td th:text="|${r.itemName} (${r.itemCode})|"></td>
										<td th:text="${r.ruleType}"></td>
										<td th:text="${r.ruleType == 'FIXED' ? r.fixedValue : r.formula}"></td>
										<td th:text="${r.fromDate}"></td>
										<td th:text="${r.toDate}"></td>
										<td>
										    <input type="checkbox" class="form-check-input" th:checked="${r.useYn == 'Y'}" onclick="return false;">
										</td>
										<td>
											<button class="btn btn-primary edit-btn" data-bs-toggle="modal" data-bs-target="#editModal" th:data-value="${r.ruleId}">수정</button>
										</td>
									</tr>
								</tbody>
								</table>
						</div>
					</div>
				</div>

				<div class="my-3 text-end">
					<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addModal">신규 규칙 등록</button>
				</div>

				<div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
				    <div class="modal-dialog modal-lg modal-dialog-centered">
				        <div class="modal-content">
				            <div class="modal-header bg-light">
				                <h5 class="modal-title" id="addModalLabel"><i class="fas fa-plus-circle me-2"></i>계산 규칙 신규 등록</h5>
				                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				            </div>
				            
				            <div class="modal-body">
				                <form id="addPayRule">
				                    <h6 class="border-bottom pb-2 mb-3 fw-bold text-primary">1. 기본 정보</h6>
				                    <div class="row g-3 mb-4">
				                        <div class="col-md-6">
				                            <label class="form-label small fw-bold">항목코드 <span class="text-danger">*</span></label>
				                            <select name="itemCode" class="form-select" id="payItemSelect" required>
				                                <option value="" selected disabled>-- 항목 선택 --</option>
				                                <option th:each="i : ${payItemList}" 
				                                        th:value="${i.itemCode}" 
				                                        th:text="|${i.itemName} (${i.itemCode})|"></option>
				                            </select>
				                        </div>
				                        <div class="col-md-6">
				                            <label class="form-label small fw-bold">계산 방식 <span class="text-danger">*</span></label>
				                            <select class="form-select" name="ruleType">
				                                <option value="FORMULA">FORMULA (수식)</option>
				                                <option value="FIXED">FIXED (고정값)</option>
				                                <option value="TABLE">TABLE (테이블 참조)</option>
				                                <option value="SQL">SQL (직접 쿼리)</option>
				                            </select>
				                        </div>
				                    </div>
				
				                    <h6 class="border-bottom pb-2 mb-3 fw-bold text-primary">2. 규칙 정의 (수식/SQL/값)</h6>
				                    <div class="row g-3 mb-4">
				                        <div class="col-12">
				                            <textarea class="form-control font-monospace" rows="5" name="formula" placeholder="계산 방식에 맞는 수식이나 쿼리를 입력하세요." style="font-size: 0.9rem;"></textarea>
				                            <div class="form-text small text-muted">※ FORMULA 예시: (P001 * 0.1) / FIXED 예시: 100000</div>
				                        </div>
				                    </div>
				
				                    <h6 class="border-bottom pb-2 mb-3 fw-bold text-primary">3. 적용 기간 및 설정</h6>
				                    <div class="row g-3 mb-4">
				                        <div class="col-md-4">
				                            <label class="form-label small fw-bold">시작일 <span class="text-danger">*</span></label>
				                            <input type="date" class="form-control" name="fromDate" required>
				                        </div>
				                        <div class="col-md-4">
				                            <label class="form-label small fw-bold">종료일 <span class="text-danger">*</span></label>
				                            <input type="date" class="form-control" name="toDate" required>
				                        </div>
				                        <div class="col-md-4">
				                            <label class="form-label small fw-bold">사용 여부</label>
				                            <div class="form-check mt-2">
				                                <input type="hidden" value="N" name="useYn"> 
				                                <input class="form-check-input" type="checkbox" value="Y" name="useYn" id="add_useYn" checked>
				                            </div>
				                        </div>
				                    </div>
				
				                    <div class="row">
				                        <div class="col-12">
				                            <label class="form-label small fw-bold">비고</label>
				                            <textarea class="form-control" rows="2" name="note" maxlength="500" placeholder="규칙에 대한 설명을 입력하세요."></textarea>
				                        </div>
				                    </div>
				                </form>
				            </div>
				
				            <div class="modal-footer bg-light">
				                <div class="d-flex gap-2 me-auto">
				                    <button type="reset" form="addPayRule" class="btn btn-outline-secondary btn-sm">
				                        <i class="fas fa-redo-alt me-1"></i> 초기화
				                    </button>
				                    <button type="button" onclick="checkSql()" class="btn btn-outline-info btn-sm">
				                        <i class="fas fa-check-circle me-1"></i> 규칙 검증
				                    </button>
				                </div>
				                <div class="d-flex gap-2">
				                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
				                    <button type="button" class="btn btn-primary" onclick="addNewPayRule()">
				                        <i class="fas fa-save me-1"></i> 저장
				                    </button>
				                </div>
				            </div>
				        </div>
				    </div>
				</div>

				<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
				    <div class="modal-dialog modal-lg modal-dialog-centered">
				        <div class="modal-content">
				            <div class="modal-header bg-light">
				                <h5 class="modal-title" id="editModalLabel"><i class="fas fa-edit me-2"></i>계산 규칙 수정</h5>
				                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				            </div>
				            
				            <div class="modal-body">
				                <form id="editPayRule">
				                    <input type="hidden" name="ruleId">
				
				                    <h6 class="border-bottom pb-2 mb-3 fw-bold text-primary">1. 기본 정보</h6>
				                    <div class="row g-3 mb-4">
				                        <div class="col-md-4">
				                            <label class="form-label small fw-bold">항목코드</label>
				                            <input type="text" class="form-control bg-light" name="itemCode" readonly>
				                        </div>
				                        <div class="col-md-4">
				                            <label class="form-label small fw-bold">항목명</label>
				                            <input type="text" class="form-control bg-light" name="itemName" readonly>
				                        </div>
				                        <div class="col-md-4">
				                            <label class="form-label small fw-bold">계산 방식</label>
				                            <select class="form-select" name="ruleType">
				                                <option value="FORMULA">FORMULA (수식)</option>
				                                <option value="FIXED">FIXED (고정값)</option>
				                                <option value="TABLE">TABLE (테이블 참조)</option>
				                                <option value="SQL">SQL (직접 쿼리)</option>
				                            </select>
				                        </div>
				                    </div>
				
				                    <h6 class="border-bottom pb-2 mb-3 fw-bold text-primary">2. 규칙 정의 수정</h6>
				                    <div class="row g-3 mb-4">
				                        <div class="col-12">
				                            <textarea class="form-control font-monospace" rows="5" name="formula" placeholder="계산 방식에 맞는 내용을 입력하세요." style="font-size: 0.9rem;"></textarea>
				                        </div>
				                    </div>
				
				                    <h6 class="border-bottom pb-2 mb-3 fw-bold text-primary">3. 적용 기간 및 설정</h6>
				                    <div class="row g-3 mb-4">
				                        <div class="col-md-4">
				                            <label class="form-label small fw-bold">시작일 <span class="text-danger">*</span></label>
				                            <input type="date" class="form-control" name="fromDate" required>
				                        </div>
				                        <div class="col-md-4">
				                            <label class="form-label small fw-bold">종료일 <span class="text-danger">*</span></label>
				                            <input type="date" class="form-control" name="toDate" required>
				                        </div>
				                        <div class="col-md-4">
				                            <label class="form-label small fw-bold">사용 여부</label>
				                            <div class="form-check mt-2">
				                                <input type="hidden" value="N" name="useYn"> 
				                                <input class="form-check-input" type="checkbox" value="Y" name="useYn" id="edit_useYn">
				                            </div>
				                        </div>
				                    </div>
				
				                    <div class="row">
				                        <div class="col-12">
				                            <label class="form-label small fw-bold">비고</label>
				                            <textarea class="form-control" rows="2" name="note" maxlength="500"></textarea>
				                        </div>
				                    </div>
				                </form>
				            </div>
				
				            <div class="modal-footer bg-light">
				                 <div class="me-auto">
				                    <button type="button" onclick="checkSql()" class="btn btn-outline-info btn-sm">
				                        <i class="fas fa-check-circle me-1"></i> 규칙 검증
				                    </button>
				                </div>
				                <div class="d-flex gap-2">
				                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
				                    <button type="button" class="btn btn-primary" onclick="updatePayRule()">
				                        <i class="fas fa-check me-1"></i> 변경사항 저장
				                    </button>
				                </div>
				            </div>
				        </div>
				    </div>
				</div>
	
	</div>
	<th:block layout:fragment="script">
        <script src="/assets/js/pay/pay-rule.js"></script>
    </th:block>
</body>
</html>