<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>인사카드 관리</title>

    <link rel="shortcut icon" href="/assets/img/favicon.png" type="image/x-icon">
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/plugins/tabler-icons/tabler-icons.min.css">
    <link rel="stylesheet" href="/assets/plugins/fontawesome/css/fontawesome.min.css">
    <link rel="stylesheet" href="/assets/plugins/fontawesome/css/all.min.css">
    <link rel="stylesheet" href="/assets/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="/assets/css/style.css">
</head>

<body>
    <div id="global-loader">
        <div class="page-loader"></div>
    </div>

    <div class="main-wrapper">

        <div class="header">
            <div class="main-header">
                <div class="header-left"><a href="/" class="logo"><img src="/assets/img/logo.svg" alt="Logo"></a></div>
                <a id="toggle_btn" href="javascript:void(0);" class="btn btn-menubar me-1"><i class="ti ti-arrow-bar-to-left"></i></a>
                <a id="mobile_btn" class="mobile_btn" href="#sidebar"><span class="bar-icon"><span></span><span></span><span></span></span></a>
            </div>
        </div>
        
        <div th:replace="~{common/sidebar :: sidebar}"></div>

        <div class="page-wrapper">
            <div class="content">

                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">사원 검색</h5>
                    </div>
                    <div class="card-body">
                        <form id="searchForm">
                            <div class="row align-items-end">
                                <div class="col-md-3">
                                    <label class="form-label">사번</label>
                                    <input type="text" class="form-control" name="pernr">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">성명</label>
                                    <input type="text" class="form-control" name="name" readonly>
                                </div>
                                <div class="col-md-6 d-flex justify-content-end gap-2">
                                     <button type="button" class="btn btn-primary" onclick="searchCard()"><i class="ti ti-search me-1"></i>조회</button>
                                     <button type="button" class="btn btn-outline-secondary" id="searchResetBtn"><i class="ti ti-refresh me-1"></i>초기화</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="editDiv" class="card" style="display: none;">
                    <div class="card-body">
						<form id="editForm">
	                        <div class="row p-3 mb-4 rounded" style="background-color: #f8f9fa;">
	                            <div class="col-md-2">
	                                <label class="form-label fw-bold">사번</label>
	                                <input type="text" class="form-control-plaintext" name="pernr" readonly>
	                            </div>
	                            <div class="col-md-2">
	                                <label class="form-label fw-bold">성명</label>
	                                <input type="text" class="form-control-plaintext" name="name" readonly>
	                            </div>
	                            <div class="col-md-3">
	                                <label class="form-label fw-bold">부서/직위</label>
	                                <input type="text" class="form-control-plaintext" name="deptPos" readonly>
	                            </div>
	                            <div class="col-md-2">
	                                <label class="form-label fw-bold">고용형태</label>
	                                <input type="text" class="form-control-plaintext" name="contractType" readonly>
	                            </div>
	                            <div class="col-md-1">
	                                <label class="form-label fw-bold">상태</label>
	                                <input type="text" class="form-control-plaintext" name="workStatus" readonly>
	                            </div>
	                        </div>

	                        <ul class="nav nav-tabs" id="employeeCardTabs" role="tablist">
	                            <li class="nav-item" role="presentation">
	                                <button class="nav-link active" id="tab-basic" data-bs-toggle="tab" data-bs-target="#basicInfo" type="button" role="tab">기본 정보</button>
	                            </li>
	                            <li class="nav-item" role="presentation">
	                                <button class="nav-link" id="tab-join" data-bs-toggle="tab" data-bs-target="#joinInfo" type="button" role="tab">입사 정보</button>
	                            </li>
	                            <li class="nav-item" role="presentation">
	                                <button class="nav-link" id="tab-guardian" data-bs-toggle="tab" data-bs-target="#guardianInfo" type="button" role="tab">보호자 정보</button>
	                            </li>
	                            <li class="nav-item" role="presentation">
	                                <button class="nav-link" id="tab-military" data-bs-toggle="tab" data-bs-target="#militaryInfo" type="button" role="tab">병역/보훈</button>
	                            </li>
	                        </ul>

	                        <div class="tab-content pt-3" id="employeeCardTabsContent">
	                            <div class="tab-pane fade show active" id="basicInfo" role="tabpanel">
	                                <div class="row">
	                                    <div class="col-md-6 mb-3">
	                                        <label class="form-label">생년월일 <span class="text-danger">*</span></label>
	                                        <input type="date" class="form-control" name="birth" required>
	                                    </div>
	                                    <div class="col-md-6 mb-3">
	                                        <label class="form-label">성별 <span class="text-danger">*</span></label>
	                                        <select class="form-select" name="sex" required>
	                                            <option value="M">남</option>
	                                            <option value="F">여</option>
	                                        </select>
	                                    </div>
	                                    <div class="col-md-6 mb-3">
	                                        <label class="form-label">국적 <span class="text-danger">*</span></label>
	                                        <input type="text" class="form-control" name="nation" required>
	                                    </div>
	                                    <div class="col-md-6 mb-3">
	                                        <label class="form-label">주민등록번호 <span class="text-danger">*</span></label>
	                                        <div class="input-group">
		                                        <input type="text" class="form-control" name="rrn" placeholder="800101-2******" required readonly>
		                                        <button class="btn btn-outline-secondary" type="button" onclick="enableRrnEdit()">등록하기</button>
									        </div>
	                                    </div>
	                                    <div class="col-md-6 mb-3">
	                                        <label class="form-label">전화번호 <span class="text-danger">*</span></label>
	                                        <input type="tel" class="form-control" name="phone" required>
	                                    </div>
	                                    <div class="col-md-6 mb-3">
	                                        <label class="form-label">이메일 <span class="text-danger">*</span></label>
	                                        <input type="email" class="form-control" name="email" required>
	                                    </div>
	                                    <div class="col-md-12 mb-3">
	                                        <label class="form-label">주소 <span class="text-danger">*</span></label>
	                                        <input type="text" class="form-control" name="addr" required>
	                                    </div>
	                                    <div class="col-md-6 mb-3">
	                                        <label class="form-label">비상연락처</label>
	                                        <input type="tel" class="form-control" name="emerPhone">
	                                    </div>
	                                </div>
	                            </div>

	                            <div class="tab-pane fade" id="joinInfo" role="tabpanel">
	                                <div class="row">
	                                    <div class="col-md-6 mb-3">
	                                        <label class="form-label">입사일 <span class="text-danger">*</span></label>
	                                        <input type="date" class="form-control" name="joinDate" required>
	                                    </div>
	                                    <div class="col-md-6 mb-3">
	                                        <label class="form-label">최초입사일</label>
	                                        <input type="date" class="form-control" name="firstJoinDate">
	                                    </div>
	                                    <div class="col-md-6 mb-3">
	                                        <label class="form-label">입사유형 <span class="text-danger">*</span></label>
	                                        <select class="form-select" name="joinType" required>
	                                            <option value="NEW">신입</option>
	                                            <option value="EXP">경력</option>
	                                            <option value="TRS">전직</option>
	                                        </select>
	                                    </div>
	                                    <div class="col-md-6 mb-3">
	                                        <label class="form-label">입사경로</label>
	                                        <select class="form-select" name="joinPath">
	                                            <option value="PUB">공채</option>
	                                            <option value="REC">추천</option>
	                                            <option value="OCC">수시채용</option>
	                                        </select>
	                                    </div>
	                                    <div class="col-md-6 mb-3">
	                                        <label class="form-label">계약구분 <span class="text-danger">*</span></label>
	                                        <select class="form-select" name="contractTypeTab" required>
	                                            <option value="REG">정규직</option>
	                                            <option value="CON">계약직</option>
	                                            <option value="DIS">파견직</option>
	                                        </select>
	                                    </div>
	                                    <div class="col-md-6 mb-3">
	                                        <label class="form-label">수습기간</label>
	                                        <input type="text" class="form-control" name="probationPeriod" placeholder="예: 3개월">
	                                    </div>
	                                    <div class="col-md-6 mb-3">
	                                        <label class="form-label">입사형태</label>
	                                        <select class="form-select" name="joinCategory">
	                                            <option value="GEN">일반채용</option>
	                                            <option value="DIS">장애인채용</option>
	                                        </select>
	                                    </div>
	                                </div>
	                            </div>

	                            <div class="tab-pane fade" id="guardianInfo" role="tabpanel">
	                                <div class="row">
	                                    <div class="col-md-6 mb-3">
	                                        <label class="form-label">보호자 성명 <span class="text-danger">*</span></label>
	                                        <input type="text" class="form-control" name="protectName" required>
	                                    </div>
	                                    <div class="col-md-6 mb-3">
	                                        <label class="form-label">관계 <span class="text-danger">*</span></label>
	                                        <select class="form-select" name="protectRel" required>
	                                            <option value="FATHER">부</option>
	                                            <option value="MOTHER">모</option>
	                                            <option value="SPOUSE">배우자</option>
	                                            <option value="OTHER">기타</option>
	                                        </select>
	                                    </div>
	                                    <div class="col-md-6 mb-3">
	                                        <label class="form-label">연락처 <span class="text-danger">*</span></label>
	                                        <input type="tel" class="form-control" name="protectPhone" required>
	                                    </div>
	                                    <div class="col-md-12 mb-3">
	                                        <label class="form-label">주소</label>
	                                        <input type="text" class="form-control" name="protectAddr">
	                                    </div>
	                                </div>
	                            </div>

	                            <div class="tab-pane fade" id="militaryInfo" role="tabpanel">
	                                <div class="row">
	                                    <div class="col-md-6 mb-3">
								            <label class="form-label">병역구분</label>
								            <select class="form-select" name="milServiceStatus">
								                <option value="FIN">병역필</option>
								                <option value="EXM">면제</option>
								                <option value="NA">미필</option>
								            </select>
								            </div>
								        <div class="col-md-6 mb-3">
								            <label class="form-label">병역종류</label>
								            <select class="form-select" name="milType">
								                <option value="ARMY">육군</option>
								                <option value="NAVY">해군</option>
								                <option value="AIR_FORCE">공군</option>
								                <option value="MARINE">해병대</option>
								                <option value="OTHER">기타</option>
								            </select>
								        </div>
	                                    <div class="col-md-6 mb-3">
	                                        <label class="form-label">병역 시작일</label>
	                                        <input type="date" class="form-control" name="milPeriodStart">
	                                    </div>
	                                    <div class="col-md-6 mb-3">
	                                        <label class="form-label">병역 종료일</label>
	                                        <input type="date" class="form-control" name="milPeriodEnd">
	                                    </div>
	                                    <div class="col-md-6 mb-3">
	                                        <label class="form-label">보훈대상여부</label>
	                                        <select class="form-select" name="vetYn">
	                                            <option value="N">아니오</option>
	                                            <option value="Y">예</option>
	                                        </select>
	                                    </div>
	                                    <div class="col-md-6 mb-3">
	                                        <label class="form-label">장애등록여부</label>
	                                        <select class="form-select" name="disabilityYn">
	                                            <option value="N">아니오</option>
	                                            <option value="Y">예</option>
	                                        </select>
	                                    </div>
	                                </div>
	                            </div>
	                        </div>
						</form>
                    </div>
                    
                    <div class="card-footer">
				        <div class="d-flex justify-content-end gap-2">
				            <button type="button" class="btn btn-primary" onclick="saveCard()">저장</button>
				        </div>
				    </div>
                </div>

            </div>

            <div th:replace="~{common/footer :: footer}"></div>
        </div>
    </div>

    <script src="/assets/js/jquery-3.7.1.min.js"></script>
    <script src="/assets/js/bootstrap.bundle.min.js"></script>
    <script src="/assets/js/jquery.slimscroll.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="/assets/js/jquery.dataTables.min.js"></script>
    <script src="/assets/js/dataTables.bootstrap5.min.js"></script>
    <script src="/assets/js/script.js"></script>
    <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {
        // [초기화] 버튼 클릭 시, 페이지 전체 상태를 초기화합니다.
        $("#searchResetBtn").on('click', function() {
            $("#editDiv").hide();
            $("#searchForm")[0].reset(); 
        });
        
    	 // 조회 또는 초기화 시 주민번호 필드를 다시 readonly로 잠그는 로직
        $("#searchResetBtn, button[onclick='searchCard()']").on('click', function() {
            const rrnInput = document.querySelector('#editForm input[name="rrn"]');
            if (rrnInput) {
                rrnInput.readOnly = true;
                rrnInput.placeholder = "조회 후 표시됩니다.";
            }
        });
    });
    
    function showEditDiv() {
        $("#editDiv").show();
    }
    
 	// 수정 모달창 데이터 불러오기.
	async function findDetail(id) {
	    try {
	        const response = await fetch(`/hr/employee-card/detail/${id}`);
	        if (!response.ok) {
	            if (response.status === 404) {
	                // 404 Not Found 에러이면 등록되지 않은 사번임
	                alert('등록되지 않은 사번입니다.');
	            } else {
	                // 그 외 다른 서버 에러
	                throw new Error('데이터를 불러오는 데 실패했습니다.');
	            }
	            return; // 함수 종료
	        }
	        
	        const data = await response.json();
	        const editForm = document.getElementById('editForm');


	        for (const key in data) {
	            const field = editForm.querySelector(`[name="${key}"]`);
	            
	            if (field) { 
                    field.value = data[key];
	            }
	        }
	        
	     	// 조회 후 rrn 필드는 항상 readonly로 설정
	        const rrnInput = editForm.querySelector('[name="rrn"]');
	        rrnInput.readOnly = true;
	        
	        showEditDiv();
	        
	    } catch (error) {
	        console.error('Error:', error);
	        alert(error.message);
	    }
	}
	
	// [조회]버튼 클릭시 상세 정보 확인
	async function searchCard() {
        const searchForm = document.getElementById('searchForm');
        const pernr = searchForm.querySelector('[name="pernr"]').value;

        // 사번 입력 여부 확인
        if (!pernr || !pernr.trim()) {
            alert('조회할 사번을 입력해주세요.');
            return;
        }
        
        
        await findDetail(pernr);
    }
	
	function enableRrnEdit() {
	    const rrnInput = document.querySelector('#editForm input[name="rrn"]');
	    
	    if (confirm('주민등록번호를 수정하시겠습니까?\n새로운 번호 전체를 다시 입력해야 합니다.')) {
	        rrnInput.readOnly = false; // 읽기 전용 해제
	        rrnInput.value = '';       // 기존 값(마스킹된 값) 삭제
	        rrnInput.placeholder = "새 주민번호를 입력 (예: 800101-1234567)";
	        rrnInput.focus();          // 입력 필드에 포커스
	    }
	}
	
	//항목 정보 수정
	async function saveCard () {
	    const editForm = document.getElementById('editForm');
	    const formData = new FormData(editForm);
	    const data = Object.fromEntries(formData.entries());
	    
	    const rrnInput = editForm.querySelector('[name="rrn"]');

	    // 주민번호 필드가 수정 가능한 상태일 때만 유효성 검사 수행
	    if (!rrnInput.readOnly) {
	        const rrnValue = rrnInput.value;
	        
	        // 정규식: 숫자 6자리 - (선택적 하이픈) - 숫자 7자리 형식인지 검사
	        const rrnRegex = /^\d{6}-?\d{7}$/; 
	        
	        if (!rrnValue || rrnValue.trim() === '') {
	            alert("주민등록번호를 입력해주세요.");
	            rrnInput.focus();
	            return; 
	        }
	        
	        if (!rrnRegex.test(rrnValue)) { // 값이 있을 때만 검사
	            alert("주민등록번호 형식이 올바르지 않습니다.\n(예: 8001011234567 또는 800101-1234567)");
	            rrnInput.focus();
	            return; 
	        }
	        
	     	// 하이픈이 있든 없든, 항상 'XXXXXX-XXXXXXX' 형식으로 만들어 서버에 전송
	        const cleanRrn = rrnValue.replace('-', '');
	        data.rrn = `${cleanRrn.substring(0, 6)}-${cleanRrn.substring(6)}`;
	    } else {
	        // 수정하지 않은 경우(readonly 상태), 마스킹된 값이 전송되지 않도록 데이터에서 제외
	        delete data.rrn;
	    }

	 	//  탭별 필수 항목 유효성 검사 ---
	    if (!data.birth || !data.sex || !data.nation || !data.phone || !data.email || !data.addr) {
	        alert('기본 정보 탭의 필수(*) 항목을 모두 입력해주세요.');
	        new bootstrap.Tab(document.getElementById('tab-basic')).show(); // 해당 탭으로 이동
	        return;
	    }
	    
	    if (!data.joinDate || !data.joinType || !data.contractTypeTab) {
	        alert('입사 정보 탭의 필수(*) 항목을 모두 입력해주세요.');
	        new bootstrap.Tab(document.getElementById('tab-join')).show(); // 해당 탭으로 이동
	        return;
	    }
	    
	    if (!data.protectName || !data.protectRel || !data.protectPhone) {
	        alert('보호자 정보 탭의 필수(*) 항목을 모두 입력해주세요.');
	        new bootstrap.Tab(document.getElementById('tab-guardian')).show(); // 해당 탭으로 이동
	        return;
	    }
	    
	    try {
	    	
	        const url = `/hr/employee-card`;
	        const response = await fetch(url, {
	            method: 'PUT', 
	            headers: {
	                'Content-Type': 'application/json',
	            },
	            body: JSON.stringify(data),
	        });

	        if (response.ok) {
	            alert('성공적으로 등록되었습니다.');
	            findDetail(data.pernr); // 성공 시 페이지 새로고침
	        } else {
	            const errorText = await response.text();
	            alert(`수정에 실패했습니다: ${errorText}`);
	        }
	    } catch (error) {
	        console.error('Error:', error);
	        alert('등록 중 오류가 발생했습니다.');
	    }
	}
    </script>
</body>
</html>